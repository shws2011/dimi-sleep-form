<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>ğŸŒ™ DIMI æ™¨é—´ç¡çœ æ•°æ®æ”¶é›† (GitHub Pagesç‰ˆæœ¬)</title>
    
    <!-- åç«¯APIé…ç½® -->
    <script>
        // Gitee APIç«¯ç‚¹é…ç½®
        // è¯·æ›¿æ¢ YOUR_GITEE_ACCESS_TOKEN ä¸ºæ‚¨çš„å®é™…ä»¤ç‰Œ
        window.DIMI_CONFIG = {
            giteeOwner: 'shws2011',
            giteeRepo: 'dimi',
            giteePath: 'memory/fitness/sleep_inputs',
            giteeToken: '', // å°†åœ¨é¦–æ¬¡ä½¿ç”¨æ—¶é…ç½®å¹¶ä¿å­˜åˆ°localStorage
            apiEndpoint: 'https://gitee.com/api/v5/repos/shws2011/dimi/contents/memory/fitness/sleep_inputs',
            environment: 'github-pages',
            enableLocalStorage: true,
            autoSaveInterval: 30000
        };
    </script>
    
    <style>
        :root {
            --primary-color: #3498db;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-color: #f8f9fa;
            --dark-color: #2c3e50;
            --border-radius: 12px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 80px;
        }
        
        .app-container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .header-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px;
            margin-bottom: 20px;
            text-align: center;
            animation: slideDown 0.5s ease;
        }
        
        .header-card h1 {
            color: var(--dark-color);
            font-size: 24px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .header-card .subtitle {
            color: #7f8c8d;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .date-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 16px;
            color: var(--dark-color);
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--primary-color);
        }
        
        .form-container {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 18px;
            color: var(--dark-color);
            margin: 0 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            font-style: normal;
            font-size: 20px;
        }
        
        .form-group {
            margin-bottom: 24px;
            position: relative;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .form-group.required label::after {
            content: " *";
            color: var(--danger-color);
        }
        
        .input-with-unit {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .input-with-unit input {
            flex: 1;
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: var(--transition);
        }
        
        .input-with-unit .unit {
            color: #7f8c8d;
            font-size: 16px;
            min-width: 40px;
        }
        
        .input-with-unit input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .input-with-unit input.valid {
            border-color: var(--success-color);
        }
        
        .input-with-unit input.invalid {
            border-color: var(--danger-color);
        }
        
        .sleep-phase-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .phase-total-display {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
            text-align: center;
            font-size: 14px;
            transition: var(--transition);
        }
        
        .phase-total-display.valid {
            background: #d5f4e6;
            color: #27ae60;
        }
        
        .phase-total-display.invalid {
            background: #fadbd8;
            color: #e74c3c;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 8px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 22px;
            height: 22px;
            accent-color: var(--primary-color);
        }
        
        .validation-message {
            font-size: 13px;
            margin-top: 6px;
            padding: 6px 10px;
            border-radius: 6px;
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .validation-message.success {
            background: #d5f4e6;
            color: #27ae60;
            display: block;
        }
        
        .validation-message.error {
            background: #fadbd8;
            color: #e74c3c;
            display: block;
        }
        
        .validation-message.info {
            background: #d6eaf8;
            color: #3498db;
            display: block;
        }
        
        .progress-bar {
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            margin: 25px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .loading-indicator {
            display: none;
            text-align: center;
            margin: 25px 0;
            color: var(--primary-color);
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        .result-card {
            display: none;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-top: 20px;
            text-align: center;
            animation: fadeIn 0.5s ease;
        }
        
        .result-card.success {
            background: #d5f4e6;
            border: 2px solid #a3e4c7;
            color: #27ae60;
        }
        
        .result-card.error {
            background: #fadbd8;
            border: 2px solid #f5b7b1;
            color: #e74c3c;
        }
        
        .result-score {
            font-size: 42px;
            font-weight: 700;
            margin: 10px 0;
        }
        
        .result-suggestion {
            font-size: 16px;
            margin-bottom: 15px;
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn {
            padding: 16px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(52, 152, 219, 0.2);
        }
        
        .btn-primary:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-secondary {
            background: #ecf0f1;
            color: var(--dark-color);
        }
        
        .btn-secondary:hover {
            background: #bdc3c7;
        }
        
        .token-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #856404;
            font-size: 14px;
        }
        
        .token-warning h4 {
            margin: 0 0 8px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 480px) {
            .app-container {
                padding: 10px;
            }
            
            .header-card, .form-container {
                padding: 20px;
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- ä»¤ç‰Œè­¦å‘Š -->
        <div class="token-warning">
            <h4>âš ï¸ é‡è¦é…ç½®è¯´æ˜</h4>
            <p>æ­¤è¡¨å•éœ€è¦é…ç½®Giteeè®¿é—®ä»¤ç‰Œæ‰èƒ½æ­£å¸¸å·¥ä½œã€‚è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š</p>
            <ol>
                <li>æ‰“å¼€ <code>dimi_sleep_form_github.html</code> æ–‡ä»¶</li>
                <li>æ‰¾åˆ°ç¬¬15è¡Œï¼š<code>giteeToken: 'YOUR_GITEE_ACCESS_TOKEN'</code></li>
                <li>å°† <code>YOUR_GITEE_ACCESS_TOKEN</code> æ›¿æ¢ä¸ºæ‚¨çš„çœŸå®Giteeä»¤ç‰Œ</li>
                <li>ä¿å­˜æ–‡ä»¶å¹¶é‡æ–°ä¸Šä¼ åˆ°GitHub</li>
            </ol>
            <p><strong>æ³¨æ„</strong>ï¼šä»¤ç‰Œä¼šæš´éœ²åœ¨å®¢æˆ·ç«¯ä»£ç ä¸­ï¼Œå»ºè®®ä»…ç”¨äºæµ‹è¯•ã€‚ç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨åç«¯ä»£ç†ã€‚</p>
        </div>
        
        <!-- å¤´éƒ¨ -->
        <div class="header-card">
            <h1>
                <span>ğŸŒ™</span>
                DIMI æ™¨é—´ç¡çœ æ•°æ®æ”¶é›†
            </h1>
            <p class="subtitle">GitHub Pagesç‰ˆæœ¬ Â· æ•°æ®å­˜å‚¨äºæ‚¨çš„Giteeç§æœ‰ä»“åº“</p>
            <p class="subtitle"><small>å¤‡ç”¨æ–¹æ¡ˆ Â· å½“é’‰é’‰ä¸å¯ç”¨æ—¶ä½¿ç”¨</small></p>
        </div>
        
        <!-- æ—¥æœŸæ˜¾ç¤º -->
        <div class="date-card">
            ğŸ“… ä»Šå¤©æ—¥æœŸï¼š<span id="current-date"></span>
        </div>
        
        <!-- Giteeä»¤ç‰Œé…ç½® -->
        <div class="form-container config-panel" id="config-panel">
            <div class="section-title">
                <i>âš™ï¸</i> Gitee APIé…ç½®
            </div>
            
            <div class="config-warning" style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <p style="margin: 0 0 10px 0; color: #856404; font-weight: 600;">âš ï¸ éœ€è¦é…ç½®Giteeä»¤ç‰Œæ‰èƒ½æäº¤æ•°æ®</p>
                <p style="margin: 0; color: #856404; font-size: 14px;">ä¸ºäº†å®‰å…¨èµ·è§ï¼ŒGitHubä¸å…è®¸åœ¨ä»£ç ä¸­å­˜å‚¨APIä»¤ç‰Œã€‚è¯·åœ¨æ­¤å¤„è¾“å…¥æ‚¨çš„Giteeä¸ªäººè®¿é—®ä»¤ç‰Œï¼š</p>
            </div>
            
            <div class="form-group required">
                <label for="gitee-token">Giteeä¸ªäººè®¿é—®ä»¤ç‰Œ</label>
                <input type="password" id="gitee-token" placeholder="è¾“å…¥æ‚¨çš„Giteeä»¤ç‰Œ (32ä½åå…­è¿›åˆ¶å­—ç¬¦)" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                <div class="help-text" style="font-size: 12px; color: #6c757d; margin-top: 5px;">
                    æ‚¨çš„Giteeä»¤ç‰Œ: <code>ed4425ff9eae674d02248852bcb8fd63</code> (ä»æ‚¨çš„é…ç½®ä¸­è·å–)
                </div>
            </div>
            
            <div class="form-group">
                <label for="save-token-local">ä¿å­˜åˆ°æœ¬åœ°æµè§ˆå™¨</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="save-token-local" checked>
                    <span style="font-size: 14px; color: #6c757d;">å‹¾é€‰åå°†ä»¤ç‰Œä¿å­˜åˆ°æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ï¼Œä¸‹æ¬¡æ— éœ€é‡æ–°è¾“å…¥</span>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="button" id="save-config-btn" class="btn btn-primary" style="flex: 1;">ä¿å­˜é…ç½®</button>
                <button type="button" id="test-config-btn" class="btn btn-secondary" style="flex: 1;">æµ‹è¯•è¿æ¥</button>
            </div>
            
            <div id="config-status" style="margin-top: 15px; padding: 10px; border-radius: 6px; display: none;"></div>
        </div>
        
        <!-- è¡¨å• -->
        <div class="form-container">
            <form id="sleep-data-form">
                <!-- ç¡çœ æ—¶é•¿ -->
                <div class="section-title">
                    <i>ğŸ˜´</i> ç¡çœ æ—¶é•¿
                </div>
                
                <div class="form-group required">
                    <label for="sleep-hours">ç¡çœ å°æ—¶</label>
                    <div class="input-with-unit">
                        <input type="number" id="sleep-hours" min="0" max="24" step="0.5" placeholder="ä¾‹å¦‚ï¼š7.5" required>
                        <span class="unit">å°æ—¶</span>
                    </div>
                    <div class="validation-message" id="hours-message"></div>
                </div>
                
                <div class="form-group required">
                    <label for="sleep-minutes">ç¡çœ åˆ†é’Ÿ</label>
                    <div class="input-with-unit">
                        <input type="number" id="sleep-minutes" min="0" max="59" step="1" placeholder="ä¾‹å¦‚ï¼š30" required>
                        <span class="unit">åˆ†é’Ÿ</span>
                    </div>
                    <div class="validation-message" id="minutes-message"></div>
                </div>
                
                <!-- ç¡çœ é˜¶æ®µ -->
                <div class="section-title">
                    <i>ğŸ“Š</i> ç¡çœ é˜¶æ®µæ¯”ä¾‹
                </div>
                
                <div class="sleep-phase-grid">
                    <div class="form-group required">
                        <label for="deep-sleep">æ·±ç¡æ¯”ä¾‹</label>
                        <div class="input-with-unit">
                            <input type="number" id="deep-sleep" min="0" max="100" step="0.1" placeholder="ä¾‹å¦‚ï¼š20.0" required>
                            <span class="unit">%</span>
                        </div>
                    </div>
                    
                    <div class="form-group required">
                        <label for="rem-sleep">REMç¡çœ æ¯”ä¾‹</label>
                        <div class="input-with-unit">
                            <input type="number" id="rem-sleep" min="0" max="100" step="0.1" placeholder="ä¾‹å¦‚ï¼š25.0" required>
                            <span class="unit">%</span>
                        </div>
                    </div>
                    
                    <div class="form-group required">
                        <label for="light-sleep">æµ…ç¡æ¯”ä¾‹</label>
                        <div class="input-with-unit">
                            <input type="number" id="light-sleep" min="0" max="100" step="0.1" placeholder="ä¾‹å¦‚ï¼š55.0" required>
                            <span class="unit">%</span>
                        </div>
                    </div>
                    
                    <div class="form-group required">
                        <label for="awake-percent">æ¸…é†’æ¯”ä¾‹</label>
                        <div class="input-with-unit">
                            <input type="number" id="awake-percent" min="0" max="100" step="0.1" placeholder="ä¾‹å¦‚ï¼š2.0" required>
                            <span class="unit">%</span>
                        </div>
                    </div>
                </div>
                
                <div class="phase-total-display" id="phase-total-display">
                    ç¡çœ é˜¶æ®µæ€»å’Œï¼š<span id="phase-total">0</span>%
                </div>
                
                <!-- ç”Ÿç†æŒ‡æ ‡ -->
                <div class="section-title">
                    <i>â¤ï¸</i> ç”Ÿç†æŒ‡æ ‡
                </div>
                
                <div class="form-group required">
                    <label for="resting-heart-rate">é™æ¯å¿ƒç‡</label>
                    <div class="input-with-unit">
                        <input type="number" id="resting-heart-rate" min="40" max="100" step="1" placeholder="ä¾‹å¦‚ï¼š55" required>
                        <span class="unit">bpm</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="hrv">HRV</label>
                    <div class="input-with-unit">
                        <input type="number" id="hrv" min="20" max="150" step="1" placeholder="ä¾‹å¦‚ï¼š65">
                        <span class="unit">ms</span>
                    </div>
                </div>
                
                <!-- èº«ä½“æˆåˆ† -->
                <div class="section-title">
                    <i>âš–ï¸</i> èº«ä½“æˆåˆ†
                </div>
                
                <div class="form-group required">
                    <label for="weight">ä½“é‡</label>
                    <div class="input-with-unit">
                        <input type="number" id="weight" min="30" max="150" step="0.1" placeholder="ä¾‹å¦‚ï¼š72.5" required>
                        <span class="unit">kg</span>
                    </div>
                </div>
                
                <div class="form-group required">
                    <label for="body-fat-percentage">ä½“è„‚ç‡</label>
                    <div class="input-with-unit">
                        <input type="number" id="body-fat-percentage" min="5" max="40" step="0.1" placeholder="ä¾‹å¦‚ï¼š15.6" required>
                        <span class="unit">%</span>
                    </div>
                </div>
                
                <!-- å…¶ä»–æŒ‡æ ‡ -->
                <div class="section-title">
                    <i>ğŸ“</i> å…¶ä»–æŒ‡æ ‡
                </div>
                
                <div class="form-group">
                    <label for="awake-count">>5åˆ†é’Ÿçš„æ¸…é†’æ¬¡æ•°</label>
                    <div class="input-with-unit">
                        <input type="number" id="awake-count" min="0" max="20" step="1" placeholder="ä¾‹å¦‚ï¼š1">
                        <span class="unit">æ¬¡</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="feeling-rested">
                        <label for="feeling-rested">æ™¨èµ·æ„Ÿè§‰ä¼‘æ¯å……åˆ†</label>
                    </div>
                </div>
                
                <!-- è¿›åº¦æ¡ -->
                <div class="progress-bar">
                    <div class="progress-fill" id="form-progress"></div>
                </div>
                
                <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
                <div class="loading-indicator" id="loading-indicator">
                    <div class="loading-spinner"></div>
                    <p>æ­£åœ¨æäº¤æ•°æ®åˆ°Giteeä»“åº“...</p>
                </div>
                
                <!-- ç»“æœå¡ç‰‡ -->
                <div class="result-card" id="result-card">
                    <div id="result-content"></div>
                </div>
                
                <!-- æ“ä½œæŒ‰é’® -->
                <div class="action-buttons">
                    <button type="button" class="btn btn-secondary" onclick="handleSaveDraft()">
                        ğŸ’¾ ä¿å­˜è‰ç¨¿
                    </button>
                    <button type="submit" class="btn btn-primary" id="submit-btn">
                        ğŸ“¤ æäº¤æ•°æ®åˆ°Gitee
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // æ˜¾ç¤ºå½“å‰æ—¥æœŸ
            const now = new Date();
            document.getElementById('current-date').textContent = 
                now.getFullYear() + '-' + 
                String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                String(now.getDate()).padStart(2, '0');
            
            // åŠ è½½è‰ç¨¿
            loadFromLocalStorage();
            
            // ç»‘å®šè¡¨å•æäº¤
            document.getElementById('sleep-data-form').addEventListener('submit', handleFormSubmit);
            
            // ç»‘å®šå®æ—¶éªŒè¯
            document.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', function() {
                    validateInput(this);
                    updateFormProgress();
                    saveToLocalStorage();
                });
            });
            
            // ç¡çœ é˜¶æ®µæ€»å’ŒéªŒè¯
            ['deep-sleep', 'rem-sleep', 'light-sleep', 'awake-percent'].forEach(id => {
                document.getElementById(id).addEventListener('input', validateSleepPhases);
            });
        });
        
        // æ”¶é›†è¡¨å•æ•°æ®
        function collectFormData() {
            const now = new Date();
            return {
                date: now.toISOString().split('T')[0],
                timestamp: now.toISOString(),
                sleep_hours: parseFloat(document.getElementById('sleep-hours').value) || 0,
                sleep_minutes: parseFloat(document.getElementById('sleep-minutes').value) || 0,
                deep_sleep_percent: parseFloat(document.getElementById('deep-sleep').value) || 0,
                rem_sleep_percent: parseFloat(document.getElementById('rem-sleep').value) || 0,
                light_sleep_percent: parseFloat(document.getElementById('light-sleep').value) || 0,
                awake_percent: parseFloat(document.getElementById('awake-percent').value) || 0,
                resting_heart_rate: parseInt(document.getElementById('resting-heart-rate').value) || 0,
                hrv: document.getElementById('hrv').value ? parseInt(document.getElementById('hrv').value) : null,
                weight: parseFloat(document.getElementById('weight').value) || 0,
                body_fat_percentage: parseFloat(document.getElementById('body-fat-percentage').value) || 0,
                awake_count: document.getElementById('awake-count').value ? parseInt(document.getElementById('awake-count').value) : null,
                feeling_rested: document.getElementById('feeling-rested').checked
            };
        }
        
        // éªŒè¯ç¡çœ é˜¶æ®µæ€»å’Œ
        function validateSleepPhases() {
            const deep = parseFloat(document.getElementById('deep-sleep').value) || 0;
            const rem = parseFloat(document.getElementById('rem-sleep').value) || 0;
            const light = parseFloat(document.getElementById('light-sleep').value) || 0;
            const awake = parseFloat(document.getElementById('awake-percent').value) || 0;
            
            const total = deep + rem + light + awake;
            const display = document.getElementById('phase-total-display');
            const totalSpan = document.getElementById('phase-total');
            
            totalSpan.textContent = total.toFixed(1);
            
            if (total === 100) {
                display.className = 'phase-total-display valid';
                return true;
            } else {
                display.className = 'phase-total-display invalid';
                return false;
            }
        }

        // Giteeä»¤ç‰Œé…ç½®ç®¡ç†
        function loadGiteeToken() {
            const savedToken = localStorage.getItem('dimi_gitee_token');
            if (savedToken && savedToken.trim() !== '') {
                window.DIMI_CONFIG.giteeToken = savedToken;
                document.getElementById('gitee-token').value = savedToken;
                console.log('ä»æœ¬åœ°å­˜å‚¨åŠ è½½Giteeä»¤ç‰Œ');
                return true;
            }
            return false;
        }

        function saveGiteeToken(token, saveToLocal = true) {
            if (!token || token.trim() === '') {
                return false;
            }
            
            // éªŒè¯ä»¤ç‰Œæ ¼å¼ï¼ˆ32ä½åå…­è¿›åˆ¶å­—ç¬¦ï¼‰
            const tokenRegex = /^[a-fA-F0-9]{32}$/;
            if (!tokenRegex.test(token)) {
                return { success: false, message: 'ä»¤ç‰Œæ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸º32ä½åå…­è¿›åˆ¶å­—ç¬¦' };
            }
            
            window.DIMI_CONFIG.giteeToken = token;
            
            if (saveToLocal) {
                localStorage.setItem('dimi_gitee_token', token);
                console.log('Giteeä»¤ç‰Œå·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
            }
            
            return { success: true, message: 'ä»¤ç‰Œé…ç½®æˆåŠŸ' };
        }

        async function testGiteeConnection(token) {
            if (!token || token.trim() === '') {
                return { success: false, message: 'è¯·å…ˆè¾“å…¥Giteeä»¤ç‰Œ' };
            }
            
            // æµ‹è¯•æ•°æ®
            const testJson = JSON.stringify({ test: true, timestamp: new Date().toISOString(), purpose: 'DIMI APIè¿æ¥æµ‹è¯•' });
            const contentBase64 = btoa(unescape(encodeURIComponent(testJson)));
            
            // å°è¯•ä¸¤ç§å¯èƒ½çš„åˆ†æ”¯ï¼šmaster å’Œ main
            const branchesToTry = ['master', 'main'];
            
            for (const branch of branchesToTry) {
                try {
                    const testData = {
                        content: contentBase64,
                        message: 'DIMI APIè¿æ¥æµ‹è¯•',
                        branch: branch
                    };
                    
                    const createFileUrl = `https://gitee.com/api/v5/repos/${window.DIMI_CONFIG.giteeOwner}/${window.DIMI_CONFIG.giteeRepo}/contents/memory/fitness/sleep_inputs/test_connection.json?access_token=${token}`;
                    const response = await fetch(createFileUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(testData)
                    });
                    
                    if (response.ok) {
                        return { success: true, message: `Gitee APIè¿æ¥æµ‹è¯•æˆåŠŸ (åˆ†æ”¯: ${branch})` };
                    } else if (branch === branchesToTry[branchesToTry.length - 1]) {
                        // å¦‚æœæ˜¯æœ€åä¸€ä¸ªåˆ†æ”¯ï¼Œè¿”å›é”™è¯¯
                        const errorText = await response.text();
                        let errorMsg = `APIè¿æ¥å¤±è´¥: ${response.status}`;
                        
                        try {
                            const errorJson = JSON.parse(errorText);
                            if (errorJson.message) {
                                errorMsg = `APIé”™è¯¯: ${errorJson.message}`;
                            }
                        } catch (e) {
                            // ä¿æŒåŸé”™è¯¯ä¿¡æ¯
                            errorMsg += ` ${errorText.substring(0, 100)}`;
                        }
                        
                        return { success: false, message: errorMsg };
                    }
                    // å¦‚æœè¿™ä¸ªåˆ†æ”¯å¤±è´¥ï¼Œç»§ç»­å°è¯•ä¸‹ä¸€ä¸ªåˆ†æ”¯
                } catch (error) {
                    if (branch === branchesToTry[branchesToTry.length - 1]) {
                        return { success: false, message: `ç½‘ç»œé”™è¯¯: ${error.message}` };
                    }
                    // ç»§ç»­å°è¯•ä¸‹ä¸€ä¸ªåˆ†æ”¯
                }
            }
            
            return { success: false, message: 'æ‰€æœ‰åˆ†æ”¯å°è¯•å‡å¤±è´¥' };
        }

        function setupConfigPanel() {
            const saveBtn = document.getElementById('save-config-btn');
            const testBtn = document.getElementById('test-config-btn');
            const tokenInput = document.getElementById('gitee-token');
            const saveLocalCheckbox = document.getElementById('save-token-local');
            const configStatus = document.getElementById('config-status');
            
            if (!saveBtn || !testBtn) return;
            
            // åŠ è½½å·²ä¿å­˜çš„ä»¤ç‰Œ
            loadGiteeToken();
            
            saveBtn.addEventListener('click', async () => {
                const token = tokenInput.value.trim();
                const saveToLocal = saveLocalCheckbox.checked;
                
                const result = saveGiteeToken(token, saveToLocal);
                
                configStatus.style.display = 'block';
                if (result.success) {
                    configStatus.style.backgroundColor = '#d4edda';
                    configStatus.style.border = '1px solid #c3e6cb';
                    configStatus.style.color = '#155724';
                    configStatus.innerHTML = `âœ… ${result.message}`;
                    
                    // è‡ªåŠ¨æµ‹è¯•è¿æ¥
                    setTimeout(async () => {
                        const testResult = await testGiteeConnection(token);
                        configStatus.innerHTML += `<br>${testResult.success ? 'âœ…' : 'âŒ'} ${testResult.message}`;
                    }, 500);
                } else {
                    configStatus.style.backgroundColor = '#f8d7da';
                    configStatus.style.border = '1px solid #f5c6cb';
                    configStatus.style.color = '#721c24';
                    configStatus.innerHTML = `âŒ ${result.message}`;
                }
            });
            
            testBtn.addEventListener('click', async () => {
                const token = tokenInput.value.trim();
                if (!token) {
                    configStatus.style.display = 'block';
                    configStatus.style.backgroundColor = '#f8d7da';
                    configStatus.style.border = '1px solid #f5c6cb';
                    configStatus.style.color = '#721c24';
                    configStatus.innerHTML = 'âŒ è¯·å…ˆè¾“å…¥Giteeä»¤ç‰Œ';
                    return;
                }
                
                configStatus.style.display = 'block';
                configStatus.style.backgroundColor = '#fff3cd';
                configStatus.style.border = '1px solid #ffeaa7';
                configStatus.style.color = '#856404';
                configStatus.innerHTML = 'â³ æ­£åœ¨æµ‹è¯•Gitee APIè¿æ¥...';
                
                const result = await testGiteeConnection(token);
                
                if (result.success) {
                    configStatus.style.backgroundColor = '#d4edda';
                    configStatus.style.border = '1px solid #c3e6cb';
                    configStatus.style.color = '#155724';
                    configStatus.innerHTML = `âœ… ${result.message}`;
                } else {
                    configStatus.style.backgroundColor = '#f8d7da';
                    configStatus.style.border = '1px solid #f5c6cb';
                    configStatus.style.color = '#721c24';
                    configStatus.innerHTML = `âŒ ${result.message}`;
                }
            });
        }

        // é¡µé¢åˆå§‹åŒ–æ—¶è®¾ç½®é…ç½®é¢æ¿
        document.addEventListener('DOMContentLoaded', function() {
            setupConfigPanel();
            
            // æ£€æŸ¥æ˜¯å¦å·²é…ç½®ä»¤ç‰Œ
            if (window.DIMI_CONFIG.giteeToken && window.DIMI_CONFIG.giteeToken.trim() !== '') {
                console.log('Giteeä»¤ç‰Œå·²é…ç½®');
            } else {
                console.log('Giteeä»¤ç‰Œæœªé…ç½®ï¼Œè¯·åœ¨ä¸Šæ–¹é…ç½®é¢æ¿ä¸­è¾“å…¥');
            }
        });

        // è¡¨å•æäº¤å¤„ç†
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            // æœ€ç»ˆéªŒè¯
            if (!validateSleepPhases()) {
                showResult('error', 'è¯·è°ƒæ•´ç¡çœ é˜¶æ®µæ¯”ä¾‹ï¼Œç¡®ä¿æ€»å’Œä¸º100%');
                return;
            }
            
            // æ£€æŸ¥Giteeä»¤ç‰Œé…ç½®
            const token = window.DIMI_CONFIG.giteeToken;
            if (!token || token.trim() === '') {
                showResult('error', 'è¯·å…ˆåœ¨ä¸Šæ–¹é…ç½®é¢æ¿ä¸­è¾“å…¥Giteeè®¿é—®ä»¤ç‰Œ<br><small>æ‚¨çš„Giteeä»¤ç‰Œ: <code>ed4425ff9eae674d02248852bcb8fd63</code></small>');
                
                // æ»šåŠ¨åˆ°é…ç½®é¢æ¿
                document.getElementById('config-panel').scrollIntoView({ behavior: 'smooth' });
                // é«˜äº®æ˜¾ç¤ºä»¤ç‰Œè¾“å…¥æ¡†
                const tokenInput = document.getElementById('gitee-token');
                tokenInput.focus();
                tokenInput.style.border = '2px solid #e74c3c';
                setTimeout(() => { tokenInput.style.border = ''; }, 2000);
                
                return;
            }
            
            const formData = collectFormData();
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const filename = `ç¡çœ æ•°æ®_${timestamp}.json`;
            const filePath = `${window.DIMI_CONFIG.giteePath}/${filename}`;
            
            // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
            document.getElementById('loading-indicator').style.display = 'block';
            document.getElementById('submit-btn').disabled = true;
            document.getElementById('result-card').style.display = 'none';
            
            try {
                // æ„å»ºGitee APIè¯·æ±‚ - ä½¿ç”¨æŸ¥è¯¢å‚æ•°ä¼ é€’ä»¤ç‰Œ
                const apiUrl = `https://gitee.com/api/v5/repos/${window.DIMI_CONFIG.giteeOwner}/${window.DIMI_CONFIG.giteeRepo}/contents/${filePath}?access_token=${token}`;
                
                // Base64ç¼–ç å†…å®¹
                const contentStr = JSON.stringify(formData, null, 2);
                const contentBase64 = btoa(unescape(encodeURIComponent(contentStr)));
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: contentBase64,
                        message: `DIMIç¡çœ æ•°æ®æäº¤ ${new Date().toLocaleString()}`,
                        branch: 'master'
                    })
                });
                
                const result = await response.json();
                
                // éšè—åŠ è½½æŒ‡ç¤ºå™¨
                document.getElementById('loading-indicator').style.display = 'none';
                document.getElementById('submit-btn').disabled = false;
                
                if (response.ok && result.content && result.commit) {
                    // æ˜¾ç¤ºæˆåŠŸç»“æœ
                    const fileUrl = result.content.html_url;
                    showResult('success', {
                        message: 'æ•°æ®å·²æˆåŠŸä¿å­˜åˆ°Giteeä»“åº“',
                        fileUrl: fileUrl,
                        filename: filename
                    });
                    
                    // æ¸…é™¤æœ¬åœ°å­˜å‚¨
                    if (window.DIMI_CONFIG.enableLocalStorage) {
                        const today = new Date().toISOString().split('T')[0];
                        localStorage.removeItem(`dimi_sleep_draft_${today}`);
                    }
                } else {
                    const errorMsg = result.message || 'Gitee APIé”™è¯¯';
                    showResult('error', `æäº¤å¤±è´¥ï¼š${errorMsg}`);
                    console.error('Gitee APIé”™è¯¯:', result);
                }
            } catch (error) {
                document.getElementById('loading-indicator').style.display = 'none';
                document.getElementById('submit-btn').disabled = false;
                showResult('error', `ç½‘ç»œé”™è¯¯ï¼š${error.message}`);
                console.error('æäº¤é”™è¯¯:', error);
            }
        }
        
        // æ˜¾ç¤ºç»“æœ
        function showResult(type, data) {
            const card = document.getElementById('result-card');
            const content = document.getElementById('result-content');
            
            card.className = `result-card ${type}`;
            
            if (type === 'success') {
                content.innerHTML = `
                    <h3>âœ… æ•°æ®æäº¤æˆåŠŸï¼</h3>
                    <p>æ‚¨çš„ç¡çœ æ•°æ®å·²å®‰å…¨ä¿å­˜åˆ°Giteeä»“åº“ã€‚</p>
                    <div class="result-suggestion">
                        <p><strong>æ–‡ä»¶åï¼š</strong> ${data.filename}</p>
                        <p><strong>æ–‡ä»¶é“¾æ¥ï¼š</strong> <a href="${data.fileUrl}" target="_blank">ç‚¹å‡»æŸ¥çœ‹</a></p>
                    </div>
                    <p><small>æäº¤æ—¶é—´ï¼š${new Date().toLocaleTimeString()}</small></p>
                    <p><em>æ³¨æ„ï¼šç¡çœ å¾—åˆ†å’Œè®­ç»ƒå»ºè®®å°†ç”±AIåœ¨é’‰é’‰ä¸­æä¾›ã€‚</em></p>
                `;
            } else {
                content.innerHTML = `
                    <h3>âŒ ${typeof data === 'string' ? data : 'æäº¤å¤±è´¥'}</h3>
                    <p>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–Giteeä»¤ç‰Œé…ç½®ã€‚</p>
                    ${typeof data === 'string' && data.includes('ä»¤ç‰Œ') ? 
                        '<p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong>æŒ‰ç…§é¡µé¢é¡¶éƒ¨çš„è¯´æ˜é…ç½®Giteeè®¿é—®ä»¤ç‰Œã€‚</p>' : ''}
                `;
            }
            
            card.style.display = 'block';
            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        // æœ¬åœ°å­˜å‚¨åŠŸèƒ½
        function saveToLocalStorage() {
            if (!window.DIMI_CONFIG.enableLocalStorage) return;
            
            const formData = collectFormData();
            const today = new Date().toISOString().split('T')[0];
            
            try {
                localStorage.setItem(`dimi_sleep_draft_${today}`, JSON.stringify(formData));
            } catch (e) {
                console.warn('æœ¬åœ°å­˜å‚¨å¤±è´¥:', e);
            }
        }
        
        function loadFromLocalStorage() {
            if (!window.DIMI_CONFIG.enableLocalStorage) return;
            
            const today = new Date().toISOString().split('T')[0];
            const saved = localStorage.getItem(`dimi_sleep_draft_${today}`);
            
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    
                    // å¡«å……è¡¨å•å­—æ®µ
                    if (data.sleep_hours) document.getElementById('sleep-hours').value = data.sleep_hours;
                    if (data.sleep_minutes) document.getElementById('sleep-minutes').value = data.sleep_minutes;
                    if (data.deep_sleep_percent) document.getElementById('deep-sleep').value = data.deep_sleep_percent;
                    if (data.rem_sleep_percent) document.getElementById('rem-sleep').value = data.rem_sleep_percent;
                    if (data.light_sleep_percent) document.getElementById('light-sleep').value = data.light_sleep_percent;
                    if (data.awake_percent) document.getElementById('awake-percent').value = data.awake_percent;
                    if (data.resting_heart_rate) document.getElementById('resting-heart-rate').value = data.resting_heart_rate;
                    if (data.hrv) document.getElementById('hrv').value = data.hrv;
                    if (data.weight) document.getElementById('weight').value = data.weight;
                    if (data.body_fat_percentage) document.getElementById('body-fat-percentage').value = data.body_fat_percentage;
                    if (data.awake_count) document.getElementById('awake-count').value = data.awake_count;
                    if (data.feeling_rested) document.getElementById('feeling-rested').checked = data.feeling_rested;
                    
                    // æ›´æ–°éªŒè¯çŠ¶æ€
                    validateSleepPhases();
                    updateFormProgress();
                    
                } catch (e) {
                    console.warn('åŠ è½½è‰ç¨¿å¤±è´¥:', e);
                }
            }
        }
        
        function handleSaveDraft() {
            saveToLocalStorage();
            alert('ğŸ’¾ è‰ç¨¿å·²ä¿å­˜ï¼å³ä½¿å…³é—­é¡µé¢ï¼Œæ•°æ®ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚');
        }
        
        // è¡¨å•è¿›åº¦
        function updateFormProgress() {
            const requiredFields = document.querySelectorAll('input[required]');
            const filledFields = Array.from(requiredFields).filter(field => field.value.trim() !== '').length;
            const progress = Math.min(100, (filledFields / requiredFields.length) * 100);
            
            document.getElementById('form-progress').style.width = progress + '%';
        }
        
        // è¾“å…¥éªŒè¯
        function validateInput(input) {
            const value = input.value.trim();
            const isValid = value !== '' && !isNaN(value) && Number(value) >= 0;
            
            input.classList.toggle('valid', isValid);
            input.classList.toggle('invalid', !isValid && value !== '');
        }
    </script>
</body>
</html>